# Feature Specification: SSH鍵管理機能

**Feature Branch**: `002-ssh-key-management`
**Created**: 2026-01-10
**Status**: Draft
**Input**: User description: "SSH鍵管理機能。expo-secure-storeでSecure Enclave連携。ED25519鍵生成、既存鍵インポート、鍵一覧、認証方法選択UI、既知ホスト管理。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 新しいSSH鍵を生成してサーバーに接続する (Priority: P1)

ユーザーはアプリ内で新しいED25519 SSH鍵ペアを生成し、その鍵を使ってリモートサーバーに安全に接続したい。鍵はデバイスのセキュアストレージに保存され、生体認証で保護される。

**Why this priority**: SSH鍵認証はパスワード認証より安全で、多くのサーバーで推奨されている。鍵生成機能がないとユーザーは外部ツールに依存する必要があり、ユーザビリティが大幅に低下する。

**Independent Test**: 新規ユーザーがアプリをインストールし、鍵を生成し、公開鍵をサーバーにコピーして、その鍵でSSH接続できることを確認する。

**Acceptance Scenarios**:

1. **Given** ユーザーが鍵管理画面にいる, **When** 「新しい鍵を生成」を選択し、鍵の名前を入力する, **Then** ED25519鍵ペアが生成され、セキュアストレージに保存され、公開鍵が表示される
2. **Given** 生成した鍵がある, **When** 接続設定で認証方法として「鍵認証」を選択し、生成した鍵を選ぶ, **Then** その鍵を使ってサーバーに接続できる
3. **Given** 鍵が生体認証で保護されている, **When** 鍵を使用する接続を開始する, **Then** 生体認証が要求され、認証成功後のみ接続が進む

---

### User Story 2 - 既存のSSH鍵をインポートする (Priority: P1)

ユーザーは他のデバイスやツールで生成した既存のSSH秘密鍵をアプリにインポートし、既存のサーバー設定を継続して使用したい。

**Why this priority**: 多くのユーザーは既にSSH鍵を持っており、それらを再利用したいというニーズがある。鍵のインポート機能は新規鍵生成と同等に重要。

**Independent Test**: ユーザーがPEM形式またはOpenSSH形式の秘密鍵ファイルをインポートし、その鍵で既存サーバーに接続できることを確認する。

**Acceptance Scenarios**:

1. **Given** ユーザーが鍵管理画面にいる, **When** 「鍵をインポート」を選択し、秘密鍵ファイルを選ぶ, **Then** 鍵が検証され、セキュアストレージに保存される
2. **Given** パスフレーズ付きの秘密鍵がある, **When** その鍵をインポートする, **Then** パスフレーズの入力が求められ、正しいパスフレーズで鍵が復号されインポートされる
3. **Given** 無効または破損した鍵ファイルがある, **When** その鍵をインポートしようとする, **Then** 適切なエラーメッセージが表示され、インポートは拒否される

---

### User Story 3 - SSH鍵を一覧・管理する (Priority: P2)

ユーザーは保存されているすべてのSSH鍵を一覧で確認し、不要な鍵の削除や鍵の詳細情報の確認ができる。

**Why this priority**: 複数の鍵を持つユーザーが鍵を整理・管理するために必要。メイン機能（生成・インポート・接続）の後に実装可能。

**Independent Test**: 複数の鍵を持つユーザーが鍵一覧を表示し、特定の鍵の詳細を確認し、不要な鍵を削除できることを確認する。

**Acceptance Scenarios**:

1. **Given** ユーザーが複数の鍵を保存している, **When** 鍵管理画面を開く, **Then** すべての鍵が名前、タイプ、作成日とともに一覧表示される
2. **Given** 鍵一覧が表示されている, **When** 特定の鍵を選択する, **Then** 公開鍵のフィンガープリント、作成日時、関連する接続設定が表示される
3. **Given** 削除したい鍵がある, **When** 削除を選択し確認する, **Then** 鍵がセキュアストレージから完全に削除される

---

### User Story 4 - 接続時に認証方法を選択する (Priority: P2)

ユーザーは接続設定時にパスワード認証とSSH鍵認証のどちらを使用するか選択でき、鍵認証の場合は使用する鍵を選べる。

**Why this priority**: 接続設定UIは鍵管理機能と統合される必要がある。既存の接続設定画面の拡張として実装。

**Independent Test**: ユーザーが新規接続設定で認証方法を切り替え、それぞれの方法で接続が成功することを確認する。

**Acceptance Scenarios**:

1. **Given** ユーザーが接続設定画面にいる, **When** 認証方法セクションを表示する, **Then** 「パスワード」と「SSH鍵」の選択肢が表示される
2. **Given** 「SSH鍵」が選択されている, **When** 鍵選択フィールドをタップする, **Then** 保存されている鍵の一覧が表示され、選択できる
3. **Given** 鍵が未登録の状態, **When** 「SSH鍵」を選択する, **Then** 「鍵を追加」へのリンクが表示され、鍵管理画面に遷移できる

---

### User Story 5 - 既知ホストを管理する (Priority: P3)

ユーザーは接続したサーバーのホスト鍵（既知ホスト）を管理し、不正なサーバーへの接続を防止できる。初回接続時にはホスト鍵の確認が求められる。

**Why this priority**: セキュリティ機能として重要だが、基本的なSSH接続機能の後に実装可能。中間者攻撃を防ぐための追加レイヤー。

**Independent Test**: ユーザーが新しいサーバーに初めて接続した際にホスト鍵確認が表示され、承認後は次回から自動的に接続できることを確認する。

**Acceptance Scenarios**:

1. **Given** ユーザーが新しいサーバーに接続しようとしている, **When** 接続を開始する, **Then** サーバーのホスト鍵フィンガープリントが表示され、承認を求められる
2. **Given** ホスト鍵が保存されている, **When** 同じサーバーに再接続する, **Then** ホスト鍵が自動的に検証され、確認なしで接続が進む
3. **Given** サーバーのホスト鍵が変更された, **When** 接続しようとする, **Then** 警告が表示され、ユーザーは新しいホスト鍵を承認するか接続を中止するか選択できる
4. **Given** ユーザーが既知ホスト管理画面にいる, **When** 特定のホストエントリを削除する, **Then** そのホストへの次回接続時に再度ホスト鍵確認が求められる

---

### Edge Cases

- 鍵生成中にアプリがクラッシュまたは中断した場合、不完全な鍵は保存されない
- セキュアストレージが利用できない（古いAndroidバージョンなど）場合、適切なエラーメッセージが表示される
- 同じ名前の鍵が既に存在する場合、上書きまたはリネームの選択肢が提示される
- パスフレーズ付き鍵で間違ったパスフレーズを入力した場合、再試行できる（最大3回）
- 既知ホストの保存領域が満杯になった場合、古いエントリの削除を提案する

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムはED25519形式のSSH鍵ペアを生成できなければならない
- **FR-002**: システムは生成した鍵にユーザー定義の名前を付けて保存できなければならない
- **FR-003**: システムはPEM形式およびOpenSSH形式の秘密鍵をインポートできなければならない
- **FR-004**: システムはパスフレーズ付き秘密鍵を復号してインポートできなければならない
- **FR-005**: システムは秘密鍵をデバイスのセキュアストレージ（Secure Enclave/Keystore連携）に保存しなければならない
- **FR-006**: システムは鍵の使用時に生体認証を要求できなければならない
- **FR-007**: システムは保存されているすべての鍵を一覧表示できなければならない
- **FR-008**: システムは各鍵の公開鍵、フィンガープリント、作成日時を表示できなければならない
- **FR-009**: システムはユーザーが鍵を削除できるようにしなければならない
- **FR-010**: システムは接続設定で「パスワード」または「SSH鍵」の認証方法を選択できなければならない
- **FR-011**: システムはSSH鍵認証時に使用する鍵をユーザーに選択させなければならない
- **FR-012**: システムは初回接続時にサーバーのホスト鍵フィンガープリントを表示し、承認を求めなければならない
- **FR-013**: システムは承認されたホスト鍵を保存し、以降の接続で自動検証しなければならない
- **FR-014**: システムはホスト鍵が変更された場合に警告を表示しなければならない
- **FR-015**: システムは既知ホストエントリの一覧表示と削除ができなければならない

### Key Entities

- **SSHKey**: SSH鍵ペアを表す。名前、タイプ（ED25519等）、公開鍵、作成日時、フィンガープリントを持つ。秘密鍵本体はセキュアストレージで別途管理される。
- **KnownHost**: 既知のサーバーホスト鍵を表す。ホスト名、ポート、鍵タイプ、フィンガープリント、最終接続日時を持つ。
- **Connection**: 接続設定。認証方法（password/key）と、key選択時は使用するSSHKeyへの参照を持つ。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーは30秒以内に新しいSSH鍵を生成し、公開鍵をクリップボードにコピーできる
- **SC-002**: ユーザーは1分以内に既存の秘密鍵ファイルをインポートして接続に使用できる
- **SC-003**: 鍵を使用した認証は、パスワード認証と同等の時間（5秒以内）で完了する
- **SC-004**: 生体認証が設定されている場合、鍵使用時に1回の認証で接続が開始される
- **SC-005**: ホスト鍵変更の警告は、変更を検知した場合に100%表示される
- **SC-006**: 秘密鍵はデバイスのセキュアストレージ外には決して保存されない

## Assumptions

- デバイスはAndroid 8.0以上で、ハードウェアKeystore（Secure Enclave相当）をサポートしている
- ユーザーは生体認証（指紋または顔認証）を設定済みである
- サポートする鍵形式はED25519を優先し、RSA (2048/4096bit) もサポートする
- 鍵のインポート時、ファイルはデバイスのローカルストレージまたはクラウドストレージから選択される
- 既知ホストのデータは接続設定と同様にローカルに保存される
