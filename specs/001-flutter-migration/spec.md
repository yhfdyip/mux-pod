# Feature Specification: Flutter Migration

**Feature Branch**: `001-flutter-migration`
**Created**: 2026-01-11
**Status**: Draft
**Input**: User description: "MuxPodをFlutterに移行。dartssh2+xterm.dart使用。docs/tmux-mobile-design-v2.mdとdocs/working/flutter-vs-rn-comparison.md参照"

## Overview

MuxPodをReact Native (Expo)からFlutterへ完全移行する。現在のreact-native-ssh-sftp（8年間メンテナンス放棄）の問題を解決し、アクティブにメンテナンスされているdartssh2 + xterm.dartを採用する。

**移行理由**:
- react-native-ssh-sftpがメンテナンス放棄状態（npm公開8年前）
- Androidビルドに多くのパッチが必要
- New Architecture未対応
- dartssh2はPure Dart実装でネイティブ依存なし、アクティブにメンテナンス中

## User Scenarios & Testing

### User Story 1 - SSH接続・ターミナル操作 (Priority: P1)

ユーザーがAndroidデバイスからリモートサーバーにSSH接続し、tmuxセッション内のペインでコマンドを実行する。

**Why this priority**: アプリの核心機能。これなしでは価値を提供できない。

**Independent Test**: 接続設定を追加し、サーバーに接続、tmuxペイン内でlsコマンドを実行して結果が表示される。

**Acceptance Scenarios**:

1. **Given** 接続設定が保存済み, **When** 接続をタップ, **Then** SSH接続が確立され、tmuxセッション一覧が表示される
2. **Given** tmuxセッションが存在, **When** ペインを選択, **Then** ペイン内容がANSIカラー対応で表示される
3. **Given** ペイン表示中, **When** コマンドを入力, **Then** キー入力がサーバーに送信され、結果が表示される
4. **Given** 接続中, **When** ネットワーク切断, **Then** エラーメッセージが表示され再接続オプションが提示される

---

### User Story 2 - 接続管理 (Priority: P1)

ユーザーが複数のサーバー接続設定を追加・編集・削除し、管理する。

**Why this priority**: ターミナル操作と並ぶ基本機能。接続設定なしでは接続できない。

**Independent Test**: 新しい接続を追加し、一覧に表示され、その接続を使って接続できる。

**Acceptance Scenarios**:

1. **Given** アプリ起動, **When** 「追加」をタップ, **Then** 接続設定フォームが表示される
2. **Given** 接続フォーム, **When** ホスト/ユーザー名/認証方法を入力して保存, **Then** 接続一覧に追加される
3. **Given** 接続一覧, **When** 接続をロングプレス, **Then** 編集・削除オプションが表示される
4. **Given** パスワード認証を選択, **When** パスワードを入力, **Then** パスワードは暗号化して保存される

---

### User Story 3 - SSH鍵管理 (Priority: P2)

ユーザーがSSH鍵をインポートまたは生成し、サーバー認証に使用する。

**Why this priority**: パスワード認証でも動作するが、鍵認証はセキュリティ上推奨される。

**Independent Test**: 鍵を生成し、その鍵を使用してサーバーに接続できる。

**Acceptance Scenarios**:

1. **Given** 鍵管理画面, **When** 「生成」をタップ, **Then** 鍵タイプ（Ed25519/RSA）選択後、鍵ペアが生成される
2. **Given** 鍵生成完了, **When** 公開鍵をコピー, **Then** クリップボードにコピーされる
3. **Given** 鍵管理画面, **When** ファイルからインポート, **Then** 秘密鍵がセキュアストレージに保存される
4. **Given** 接続設定, **When** 認証方法を「鍵」に選択, **Then** 保存済みの鍵一覧から選択できる

---

### User Story 4 - tmuxナビゲーション (Priority: P2)

ユーザーがtmuxのセッション/ウィンドウ/ペインを階層的にナビゲーションする。

**Why this priority**: 複数セッション/ペインを持つユーザーには必須。

**Independent Test**: 複数セッションがある状態で、セッション/ウィンドウ/ペイン間を移動できる。

**Acceptance Scenarios**:

1. **Given** 接続完了, **When** セッション一覧を表示, **Then** 全セッションが名前と作成日時付きで表示される
2. **Given** セッション選択, **When** ウィンドウをタップ, **Then** そのウィンドウのペイン一覧が表示される
3. **Given** 複数ペインのウィンドウ, **When** ペインを選択, **Then** 選択したペインの内容が表示される
4. **Given** ペイン表示中, **When** ジェスチャーでスワイプ, **Then** 隣のペイン/ウィンドウに切り替わる

---

### User Story 5 - 通知ルール (Priority: P3)

ユーザーがターミナル出力にパターンマッチルールを設定し、マッチ時にアプリ内通知を受け取る。

**Why this priority**: 便利機能だが、コア機能ではない。

**Independent Test**: 「error」というテキストルールを設定し、ターミナルにerrorが表示されたら通知が発生する。

**Acceptance Scenarios**:

1. **Given** 通知ルール画面, **When** 新規ルール追加, **Then** テキスト/正規表現パターンを設定できる
2. **Given** ルール設定済み, **When** ペイン出力がパターンにマッチ, **Then** アプリ内通知が表示される
3. **Given** 通知発生, **When** 通知をタップ, **Then** 該当ペインに移動する

---

### User Story 6 - 表示設定 (Priority: P3)

ユーザーがターミナルのフォント、フォントサイズ、カラーテーマをカスタマイズする。

**Why this priority**: 使いやすさ向上の機能。デフォルト設定でも利用可能。

**Independent Test**: フォントサイズを変更し、ターミナル表示に反映される。

**Acceptance Scenarios**:

1. **Given** 設定画面, **When** フォントサイズを変更, **Then** ターミナル表示に即座に反映される
2. **Given** 設定画面, **When** カラーテーマを選択, **Then** ターミナルの配色が変更される
3. **Given** 日本語フォント選択, **When** ターミナル表示, **Then** 日本語が正しく表示される

---

### Edge Cases

- **接続タイムアウト**: SSH接続が設定時間内に確立できない場合、明確なエラーメッセージを表示する
- **tmux未インストール**: サーバーにtmuxがインストールされていない場合、適切なメッセージを表示する
- **セッションなし**: tmuxセッションが存在しない場合、セッション作成オプションを提示する
- **ネットワーク切断**: 接続中にネットワークが切断された場合、再接続機能を提供する
- **大量出力**: 高速な出力がある場合でもUIがフリーズしない
- **無効な鍵フォーマット**: サポートされていない鍵形式のインポート時にエラーを表示する

## Requirements

### Functional Requirements

- **FR-001**: アプリはdartssh2を使用してSSH接続を確立できなければならない
- **FR-002**: アプリはxterm.dartを使用してターミナル表示を行わなければならない
- **FR-003**: アプリはパスワード認証と公開鍵認証の両方をサポートしなければならない
- **FR-004**: アプリはtmuxセッション/ウィンドウ/ペインの一覧取得と選択ができなければならない
- **FR-005**: アプリはANSIエスケープシーケンス（256色）を正しくレンダリングしなければならない
- **FR-006**: アプリは日本語（CJK文字）を正しく表示しなければならない
- **FR-007**: アプリは特殊キー（ESC、Ctrl+文字、矢印キー等）を送信できなければならない
- **FR-008**: アプリは接続設定をローカルストレージに永続化しなければならない
- **FR-009**: アプリはパスワード/秘密鍵を暗号化して保存しなければならない
- **FR-010**: アプリはSSH鍵（Ed25519/RSA）を生成できなければならない
- **FR-011**: アプリはSSH鍵をファイルからインポートできなければならない
- **FR-012**: アプリは通知ルール（テキスト/正規表現マッチ）を設定できなければならない
- **FR-013**: アプリはマッチ時にアプリ内通知を発火しなければならない
- **FR-014**: アプリはフォントサイズ/フォントファミリー/カラーテーマを設定できなければならない
- **FR-015**: アプリはターミナルサイズ変更時にPTYサイズを同期しなければならない

### Key Entities

- **Connection**: SSH接続設定（ホスト、ポート、ユーザー名、認証方法、関連付けられた鍵）
- **SSHKey**: SSH鍵ペア（タイプ、フィンガープリント、公開鍵、暗号化された秘密鍵）
- **TmuxSession**: tmuxセッション（名前、作成日時、ウィンドウ一覧）
- **TmuxWindow**: tmuxウィンドウ（インデックス、名前、ペイン一覧）
- **TmuxPane**: tmuxペイン（ID、インデックス、サイズ、カーソル位置）
- **NotificationRule**: 通知ルール（パターン、対象ペイン、アクション）
- **AppSettings**: アプリ設定（表示設定、ターミナル設定、SSH設定、セキュリティ設定）

## Success Criteria

### Measurable Outcomes

- **SC-001**: ユーザーはSSH接続を5秒以内に確立できる（通常のネットワーク環境）
- **SC-002**: ターミナル入力のレイテンシが200ms以下である
- **SC-003**: ANSIカラー（256色）が正しくレンダリングされる（既存テストケースでの合格率100%）
- **SC-004**: 日本語文字がターミナルで正しく表示される（文字化けなし）
- **SC-005**: 1000行/秒の出力でもUIがフリーズしない
- **SC-006**: 接続設定の追加から接続完了まで3タップ以内で完了できる
- **SC-007**: 既存のReact Native実装と同等以上の機能を提供する
- **SC-008**: ビルドがネイティブパッチなしで成功する

## Assumptions

- ユーザーのサーバーにはtmuxがインストールされている
- ユーザーはSSHアクセス可能な認証情報を持っている
- 対象プラットフォームはAndroidのみ（iOS/デスクトップは将来検討）
- 既存のReact Native実装の全機能を移行対象とする
- Pure Dart実装（dartssh2）を使用することでネイティブ依存を排除する

## Out of Scope

- iOS対応（将来のフェーズ）
- デスクトップ対応（将来のフェーズ）
- MOSH対応
- SFTP（ファイル転送）
- ポートフォワーディング
- 外部プッシュ通知（ntfy連携）
