# Feature Specification: MuxPod Phase 1 MVP

**Feature Branch**: `001-phase1-mvp`
**Created**: 2026-01-10
**Status**: Draft
**Input**: MuxPod Phase 1 MVP - SSH接続基盤、接続管理UI、tmux基本操作、ターミナル表示、キー入力機能を含む

## 概要

MuxPodは、AndroidスマートフォンからSSH経由でリモートサーバーのtmuxセッション・ウィンドウ・ペインを閲覧・操作するExpo (React Native) アプリケーション。Phase 1 MVPでは、SSH接続基盤の確立、接続管理UI、tmux基本操作、ターミナル表示、キー入力機能を実装する。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - SSH接続の確立 (Priority: P1)

ユーザーはリモートサーバーへのSSH接続を確立し、tmuxセッションにアクセスできる。サーバー情報（ホスト、ポート、ユーザー名）と認証情報（パスワードまたはSSH鍵）を入力して接続を開始する。

**Why this priority**: SSH接続はアプリの根幹機能であり、これがなければ他のすべての機能が動作しない。ユーザーがサーバーに接続できなければ、tmux操作もターミナル表示も不可能。

**Independent Test**: サーバー情報を入力して「接続」をタップし、正常に接続が確立されてtmuxセッション一覧が表示されることを確認できる。

**Acceptance Scenarios**:

1. **Given** ユーザーが接続一覧画面にいる, **When** 新規接続を追加してサーバー情報とパスワードを入力し「接続」をタップ, **Then** SSH接続が確立され、tmuxセッション一覧画面に遷移する
2. **Given** 既存の接続設定がある, **When** その接続カードをタップ, **Then** 保存された認証情報で接続が開始される
3. **Given** 無効な認証情報を入力, **When** 「接続」をタップ, **Then** エラーメッセージが表示され、ユーザーは再試行できる

---

### User Story 2 - 接続管理 (Priority: P1)

ユーザーは複数のサーバー接続設定を追加、編集、削除できる。各接続には表示名、ホスト、ポート、ユーザー名、認証方法が設定可能。

**Why this priority**: 接続管理はSSH接続と同等に重要。ユーザーが接続情報を保存・管理できなければ、毎回手動で入力が必要になり実用性が大幅に低下する。

**Independent Test**: 接続を追加・編集・削除し、アプリを再起動しても設定が保持されていることを確認できる。

**Acceptance Scenarios**:

1. **Given** 接続一覧画面, **When** 「+」ボタンをタップして接続情報を入力し保存, **Then** 新しい接続が一覧に追加される
2. **Given** 既存の接続がある, **When** 接続カードを長押しして「編集」を選択, **Then** 接続編集画面が表示され、変更を保存できる
3. **Given** 既存の接続がある, **When** 接続カードを長押しして「削除」を選択し確認, **Then** 接続が一覧から削除される
4. **Given** 接続設定を追加, **When** アプリを終了して再起動, **Then** 保存した接続設定が復元されている

---

### User Story 3 - tmuxセッション・ウィンドウ・ペインのナビゲーション (Priority: P2)

ユーザーは接続中のサーバーのtmuxセッション、ウィンドウ、ペインの階層構造を閲覧し、任意のペインを選択して表示できる。

**Why this priority**: tmux操作はSSH接続確立後に必要な機能。セッション/ウィンドウ/ペインをナビゲートできなければ、特定のペインにアクセスできない。

**Independent Test**: 接続後にセッション一覧が表示され、セッション→ウィンドウ→ペインとドリルダウンして目的のペインを選択できる。

**Acceptance Scenarios**:

1. **Given** SSH接続が確立されている, **When** ターミナル画面でセッションタブをタップ, **Then** 利用可能なtmuxセッション一覧が表示される
2. **Given** セッション一覧が表示されている, **When** セッションを選択, **Then** そのセッションのウィンドウ一覧が表示される
3. **Given** ウィンドウが選択されている, **When** ペインセレクターを使用, **Then** 複数ペインがある場合は選択可能、単一ペインの場合は自動選択される

---

### User Story 4 - ターミナル表示 (Priority: P2)

ユーザーは選択したペインの内容をANSIカラー対応のターミナルビューで閲覧できる。日本語文字も正しく表示される。

**Why this priority**: ペインの内容が見えなければ、リモート操作の意味がない。ターミナル表示はtmuxナビゲーションと密接に連携する。

**Independent Test**: ペインを選択後、ターミナル出力がANSIカラー付きで正しく表示され、日本語テキストも文字化けせずに表示される。

**Acceptance Scenarios**:

1. **Given** ペインが選択されている, **When** ターミナル画面を表示, **Then** ペインの現在の内容がリアルタイムで表示される
2. **Given** ペイン内にANSIカラーコードを含む出力がある, **When** ターミナル画面を表示, **Then** 正しい色で表示される
3. **Given** ペイン内に日本語テキストがある, **When** ターミナル画面を表示, **Then** 日本語が正しく表示される
4. **Given** ターミナル画面を表示中, **When** リモートでコマンドが実行される, **Then** 出力がリアルタイムで更新される

---

### User Story 5 - キー入力 (Priority: P2)

ユーザーはソフトウェアキーボードまたは特殊キーバーから文字や特殊キー（Enter、Tab、ESC、矢印キー、Ctrl+キー）を入力し、選択中のペインに送信できる。

**Why this priority**: 入力機能がなければ閲覧のみになり、リモート操作アプリとしての価値が半減する。ターミナル表示と組み合わせて双方向のインタラクションを実現する。

**Independent Test**: キーボードから文字を入力し、特殊キーバーからEnterやCtrl+Cを送信して、リモートペインで反映されることを確認できる。

**Acceptance Scenarios**:

1. **Given** ペインが選択されている, **When** テキストを入力してEnterを送信, **Then** コマンドがリモートペインで実行される
2. **Given** ペインが選択されている, **When** 特殊キーバーのESCボタンをタップ, **Then** ESCキーがペインに送信される
3. **Given** ペインが選択されている, **When** Ctrl+Cを送信, **Then** 実行中のプロセスが中断される
4. **Given** ペインが選択されている, **When** 矢印キーを送信, **Then** カーソル移動やヒストリーナビゲーションが動作する

---

### Edge Cases

- SSH接続中にネットワークが切断された場合、ユーザーに通知し再接続オプションを提示する
- サーバーにtmuxがインストールされていない場合、エラーメッセージを表示する
- tmuxセッションが存在しない場合、新規セッション作成を促すメッセージを表示する
- 非常に長い行（画面幅を超える行）の折り返し表示を正しく処理する
- 高速な出力（ログストリーミング等）でも表示が追従する
- SSH接続タイムアウト時に適切なエラーメッセージを表示する

## Requirements *(mandatory)*

### Functional Requirements

#### SSH接続基盤

- **FR-001**: システムはパスワード認証によるSSH接続を確立できなければならない
- **FR-002**: システムはSSH鍵認証（ed25519、RSA、ECDSA）による接続を確立できなければならない
- **FR-003**: システムはカスタムポート（1-65535）でのSSH接続をサポートしなければならない
- **FR-004**: システムは接続タイムアウトを設定可能にしなければならない（デフォルト30秒）
- **FR-005**: システムはKeepAlive間隔を設定可能にし、接続維持をサポートしなければならない

#### 接続管理

- **FR-006**: ユーザーは新規SSH接続設定を作成できなければならない
- **FR-007**: ユーザーは既存の接続設定を編集できなければならない
- **FR-008**: ユーザーは既存の接続設定を削除できなければならない
- **FR-009**: 接続設定はローカルストレージに永続化されなければならない
- **FR-010**: パスワードは暗号化されたセキュアストレージに保存されなければならない
- **FR-011**: 接続一覧は最終接続日時でソート可能でなければならない

#### tmux操作

- **FR-012**: システムはサーバー上のtmuxセッション一覧を取得できなければならない
- **FR-013**: システムは各セッションのウィンドウ一覧を取得できなければならない
- **FR-014**: システムは各ウィンドウのペイン一覧を取得できなければならない
- **FR-015**: システムは指定したペインの内容をキャプチャできなければならない
- **FR-016**: システムは指定したペインにキー入力を送信できなければならない

#### ターミナル表示

- **FR-017**: システムはANSIカラーコード（16色、256色）をパースして表示できなければならない
- **FR-018**: システムは日本語文字（全角文字）を正しく表示できなければならない
- **FR-019**: システムはスクロールバック機能（履歴表示）をサポートしなければならない
- **FR-020**: システムはペイン内容をポーリングしてリアルタイム更新しなければならない（100msごと）

#### キー入力

- **FR-021**: ユーザーは通常のテキスト文字を入力できなければならない
- **FR-022**: ユーザーはEnter、Tab、Backspace、ESCキーを送信できなければならない
- **FR-023**: ユーザーは矢印キー（上下左右）を送信できなければならない
- **FR-024**: ユーザーはCtrl+キーの組み合わせを送信できなければならない

### Key Entities

- **Connection**: SSH接続設定を表す。ホスト、ポート、ユーザー名、認証方法、表示名を持つ。接続履歴やカスタマイズ情報も保持。
- **TmuxSession**: tmuxセッションを表す。セッション名、作成日時、アタッチ状態、所属ウィンドウのリストを持つ。
- **TmuxWindow**: tmuxウィンドウを表す。インデックス、ウィンドウ名、アクティブ状態、所属ペインのリストを持つ。
- **TmuxPane**: tmuxペインを表す。インデックス、ID、アクティブ状態、現在のコマンド、サイズ、カーソル位置を持つ。
- **PaneContent**: ペインの表示内容を表す。行ごとのテキスト、スクロールバックサイズ、カーソル位置を持つ。

## Assumptions

- ターゲットサーバーにはtmuxがインストール済みであり、SSHでアクセス可能である
- ユーザーはSSH接続に必要な認証情報（パスワードまたは秘密鍵）を持っている
- 端末サイズはスマートフォンの画面に収まる標準的なサイズ（80x24など）を想定
- ネットワーク遅延は一般的なモバイル環境（4G/WiFi）を想定
- Phase 1ではSSH鍵の生成・Secure Enclave連携は対象外（Phase 2で対応）
- Phase 1では通知機能は対象外（Phase 2で対応）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーは新規接続設定の作成から初回接続までを2分以内に完了できる
- **SC-002**: SSH接続確立からtmuxセッション一覧表示まで5秒以内で完了する
- **SC-003**: ペイン選択からターミナル内容表示まで1秒以内で完了する
- **SC-004**: ターミナル更新遅延は200ms以下で、リアルタイムに近い体験を提供する
- **SC-005**: キー入力から画面反映まで300ms以下で完了する
- **SC-006**: 10以上のセッション、各セッション10以上のウィンドウがあっても快適にナビゲートできる
- **SC-007**: 1000行のスクロールバック履歴を保持しても、スクロール操作がスムーズ（60fps維持）
- **SC-008**: 接続設定を5件以上保存しても、アプリ起動時間は3秒以内
